<?
//
// $Id$
//
require_once("f_runmode.phtml");
$mode = RunMode($PHP_SELF);
//
// Assign incoming arguments to themselves to prevent 'uninitialized variable' warnings later.
//
//
if ($mode) error_reporting(E_ALL);
//
require_once("f_homepageurl.phtml");
require_once("f_putlibphotorandomplaced.phtml");
require_once("f_bodyopen.phtml");
require_once("f_roleemailaddress.phtml");
require_once("f_password.phtml");
require_once("f_connectselectdb.phtml");
require_once("f_bevalidboardingpass.phtml");
require_once("f_kickoff.phtml");
//
$connected = (ConnectSelectDb('localhost','kalipso',Password(),'keyclick') == "TRUE");
?>
<html>

<head><title>KEYclick - Export Full ROD</title></head>

<? BodyOpen(); ?>
<table border="0" cellpadding="0" cellspacing="0" width="80%" align="center">
   <tr>
      <td>
        <table>
           <tr>
              <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
              <td>
                 <h6 align="center"><a href="<? echo HomePageUrl(); ?>">KEYCLICK SYSTEM</a></h6>
                 <h1 align="center">Export Full ROD</h1>
              </td>
              <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
              <td><? PutLibPhotoRandomPlaced("eye-candy",1); ?></td>
           </tr>
        </table>
        <hr>
        <br>
        <?
        if ($connected != "TRUE")
           {
           ?>
           <h2><i>Sorry...</i></h2>
           <b>
           <blockquote>
              <? echo "<p>KEYclick's database is temporarily offline.&nbsp; Please try again later.</p>"; ?>
           </blockquote>            
           </b>
           <?
           }
        else
           {
           //
           $agency = BeValidBoardingPass($bpn,$mode);
           if ($agency == "")
              {
              KickOff($mode);
              }
           else
              {
              //
              extract(  //Sets $num_rows
                 mysql_fetch_array(
                    mysql_query("select count(*) as num_rows from keyclick." . $mode . "resident")));
              //
              extract(  //Sets $chunk_size
                 mysql_fetch_array(
                    mysql_query("select value as chunk_size from keyclick." . $mode . "tuning_parm where name='export-chunk-size'")));
              //
              $num_chunks = ceil($num_rows/$chunk_size);
              ?>
              <p>Because of its size, the Full ROD must be downloaded as multiple ZIP files.&nbsp; KEYclick
                 recommends that you deliver the ZIP files, unaltered, to Corporate Marketing Inc. via email or floppy
                 disk.</p>
              <p><b>Please <u>WAIT PATIENTLY</u> after clicking a button.&nbsp; In each case, it will take a while for the
                 server to crunch the data before starting the download.</b></p>
              <blockquote>
                 <?
                 for ($i = 1; $i <= $num_chunks; $i++)
                    {
                    $sql = "select id "
                       . "   ,name "
                       . "   ,address1 "
                       . "   ,city "
                       . "   ,state "
                       . "   ,zip "
                       . "from " . $mode . "resident "
                       . "where agency = '$agency' "
                       . "limit " . ($i - 1)*$chunk_size . "," . $chunk_size;
                    echo "<form action=" . $mode . "export.phtml method=post>\n"
                       . "   <input type=hidden name=bpn value=" . $bpn . ">\n"
                       . "   <input type=hidden name=filename value=resident-part-" . $i . "-of-" . $num_chunks . ">\n"
                       . "   <input type=hidden name=whole_query value=\"$sql\">\n"
                       . "   <input type=submit value=\"Download Full ROD Part " . $i . "\">\n"
                       . "</form>\n";
                    }
                 ?>
              </blockquote>
              <?
              }
           }
        ?>
        <br>
        <p><small><small><em><pre>$Id$</pre></em></small></small>
      </td>
    </tr>
  </table>
</body>

</html>
